!function(e){var o={};function t(n){if(o[n])return o[n].exports;var r=o[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,t),r.l=!0,r.exports}t.m=e,t.c=o,t.d=function(e,o,n){t.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,o){if(1&o&&(e=t(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var r in e)t.d(n,r,function(o){return e[o]}.bind(null,r));return n},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=22)}([function(e,o,t){"use strict";o.a={DB_URL:"mongodb://test:123456@localhost:27017/testdb",REDIS:{host:"localhost",port:15001,password:"123456"},JWT_SECRET:"hkahfh800q@#80d"}},function(e,o){e.exports=require("mongoose")},function(e,o){e.exports=require("redis")},function(e,o){e.exports=require("koa-router")},function(e,o){e.exports=require("koa")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("koa-jwt")},function(e,o){e.exports=require("koa-helmet")},function(e,o){e.exports=require("koa-static")},function(e,o){e.exports=require("koa-combine-routers")},function(e,o){e.exports=require("svg-captcha")},function(e,o){e.exports=require("bluebird")},function(e,o){e.exports=require("nodemailer")},function(e,o){e.exports=require("moment")},function(e,o){e.exports=require("jsonwebtoken")},function(e,o){e.exports=require("koa-body")},function(e,o){e.exports=require("koa-json")},function(e,o){e.exports=require("@koa/cors")},function(e,o){e.exports=require("koa-compose")},function(e,o){e.exports=require("koa-compress")},function(e,o,t){"use strict";o.a=(e,o)=>o().catch(o=>{if(401!=o.status)throw o;e.status=401,e.body={code:401,message:"Protected resource, use Authorization header to get access\n"}})},function(e,o,t){"use strict";var n=t(9),r=t.n(n),s=t(3),i=t.n(s),c=t(10),a=t.n(c),u=t(2),l=t.n(u),d=t(11),p=t(0);const f={host:p.a.REDIS.host,port:p.a.REDIS.port,password:p.a.REDIS.password,detect_buffers:!0,retry_strategy:function(e){return e.error&&"ECONNREFUSED"===e.error.code?new Error("The server refused the connection"):e.total_retry_time>36e5?new Error("Retry time exhausted"):e.attempt>10?void 0:Math.min(100*e.attempt,3e3)}},g=Object(d.promisifyAll)(l.a.createClient(f));g.on("error",e=>{console.log("Redis clent errir:"+e)});var m=new class{constructor(){}async getCaptcha(e){const o=e.request.query;console.log(o);const t=a.a.create({size:4,ignoreChars:"0o1il",color:!0,noise:Math.floor(5*Math.random()),width:150,height:38});var n,r,s;n=o.sid,r=t.text,s=600,null!=r&&("string"==typeof r?"nudefinde"!==s?g.set(n,r,"EX",s,l.a.print):g.set(n,r,l.a.print):"object"==typeof r&&Object.keys(r).forEach(e=>{console.log(n,e,r[e]),g.hset(n,e,r[e],l.a.print)})),e.body={code:200,data:t.data}}async login(){}};const b=new i.a;b.prefix("/public"),b.get("/getCaptcha",m.getCaptcha);var h=b,y=t(12),x=t.n(y);var v=async function(e){let o=x.a.createTransport({host:"smtp.qq.com",port:587,secure:!1,auth:{user:"imoocbrian@qq.com",pass:"rbkcbxwrurygjfca"}});return(await o.sendMail({from:'"认证邮件" <imoocbrian@qq.com>',to:e.email,subject:""!==e.user?`你好开发者，${e.user}！《慕课网前端全栈实践》注册码`:"《慕课网前端全栈实践》注册码",text:`您在《慕课网前端全栈实践》课程中注册，您的邀请码是${e.code},邀请码的过期时间: ${e.expire}`,html:`\n        <div style="border: 1px solid #dcdcdc;color: #676767;width: 600px; margin: 0 auto; padding-bottom: 50px;position: relative;">\n        <div style="height: 60px; background: #393d49; line-height: 60px; color: #58a36f; font-size: 18px;padding-left: 10px;">Imooc社区——欢迎来到官方社区</div>\n        <div style="padding: 25px">\n          <div>您好，${e.user}童鞋，重置链接有效时间30分钟，请在${e.expire}之前重置您的密码：</div>\n          <a href="http://www.imooc.com" style="padding: 10px 20px; color: #fff; background: #009e94; display: inline-block;margin: 15px 0;">立即重置密码</a>\n          <div style="padding: 5px; background: #f2f2f2;">如果该邮件不是由你本人操作，请勿进行激活！否则你的邮箱将会被他人绑定。</div>\n        </div>\n        <div style="background: #fafafa; color: #b4b4b4;text-align: center; line-height: 45px; height: 45px; position: absolute; left: 0; bottom: 0;width: 100%;">系统邮件，请勿直接回复</div>\n    </div>\n    `})).messageId},w=t(13),q=t.n(w),k=t(14),j=t.n(k);const E=async(e,o)=>{const t=await(n=e,g.getAsync(n));var n;return null!=t&&t.toLowerCase()==o.toLowerCase()};var _=t(1),S=t.n(_);S.a.connect(p.a.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}),S.a.connection.on("connected",()=>{console.log("Mongoose connection open to "+p.a.DB_URL)}),S.a.connection.on("error",e=>{console.log("Mongoose connection error: "+e)}),S.a.connection.on("disconnected",()=>{console.log("Mongoose connection disconnected")});var M=S.a;const R=new(0,M.Schema)({userName:{type:String},password:{type:String}});var C=M.model("users",R);var O=new class{constructor(){}async forget(e){const{body:o}=e.request;console.log(o);try{let t=await v({code:"1234",expire:q()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:o.username,user:"Brian"});e.body={code:200,data:t,msg:"邮件发送成功"}}catch(e){console.log(e)}}async login(e){const{body:o}=e.request;let t=o.sid,n=o.code;if(E(t,n)){console.log("checkCode ok!");let t=!1,n=await C.findOne({username:o.username});if(console.log(n),n.password==o.password&&(t=!0),t){let o=j.a.sign({_id:"cy"},p.a.JWT_SECRET,{expiresIn:"1d"});e.body={code:200,token:o},console.log("hello login ")}else e.body={code:"401",msg:"用户名密码错误，请检查！"}}else e.body={code:401,msg:"图片验证码不正确，请检查！"}}};const T=new i.a;T.prefix("/login"),T.post("/forget",O.forget),T.post("/login",O.login);var D=T;o.a=r()(h,D)},function(e,o,t){"use strict";t.r(o),function(e){var o=t(4),n=t.n(o),r=t(5),s=t.n(r),i=t(6),c=t.n(i),a=t(7),u=t.n(a),l=t(8),d=t.n(l),p=t(21),f=t(15),g=t.n(f),m=t(16),b=t.n(m),h=t(17),y=t.n(h),x=t(18),v=t.n(x),w=t(19),q=t.n(w),k=t(0),j=t(20);const E=new n.a,_=c()({secret:k.a.JWT_SECRET}).unless({path:[/^\/public/,/^\/login/]}),S=v()([g()(),d()(s.a.join(e,"../public")),y()(),b()({pretty:!1,param:"pretty"}),u()(),j.a,_]);E.use(q()()),E.use(S),E.use(Object(p.a)()),E.listen(3e3)}.call(this,"src")}]);